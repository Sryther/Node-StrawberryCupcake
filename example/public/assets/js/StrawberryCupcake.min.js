/*! StrawberryCupcake 2015-03-22 */
var app=angular.module("StrawberryCupcake",["ui.router","ui.bootstrap","ngCookies","ngResource","permission","uiGmapgoogle-maps","btford.socket-io"]);app.config(["$httpProvider",function(a){a.interceptors.push("AuthInterceptor")}]),app.config(function(a){a.configure({key:"AIzaSyBMA4UIe4S5OjrZlNQx6DDME-xFxg0r-2w",v:"3.17",libraries:"weather,geometry,visualization"})}),app.controller("AuthController",["$scope","$rootScope","$cookies","$q","$resource","$window","$location","HashFactory","AuthService","ResourceService",function(a,b,c,d,e,f,g,h,i,j){var k=j.Client;a.credentials={username:"",password:""},a.login=function(){var c={};c.clientname=a.credentials.clientname,c.password=h.hash(a.credentials.password),k.login(c,function(a){var c=a.token;f.sessionStorage.token=c,b.addAlert("success","Welcome!"),k.me(null,function(a){b.client=a}),g.path("/")},function(){b.addAlert("danger","Wrong combination clientname/password.")})},a.register=function(){b.toggleLoading();var c=new k({email:a.credentials.email,password:CryptoJS.SHA512(a.credentials.password).toString(CryptoJS.enc.Hex),fullname:a.credentials.fullname,clientname:a.credentials.clientname}),d=CryptoJS.SHA512(a.credentials.password_confirmation).toString(CryptoJS.enc.Hex);c.password==d?k.register(c,function(){g.path("/login"),b.toggleLoading()},function(){g.path("/register"),b.toggleLoading(),b.addAlert("danger","An error occured.")}):(b.toggleLoading(),b.addAlert("danger","Please fill all the fields required or correct them.",5e3))};a.logout=function(){delete f.sessionStorage.token,g.path("/login")}}]),app.controller("ConversationsController",["$scope","$rootScope","$stateParams","Socket","ResourceService",function(a,b,c,d,e){var f=e.Conversation,g=e.Client;a.conversations=[],a.currentConversation={},a.session="",a.yourMessage="",a.socket={},c.session&&(a.session=c.session),a.numPerPage=20,a.filteredConversations=[],a.currentPage=1,a.selectAll={isSelected:!1},a.initSocket=function(c){g.me(null,function(b){a.socket=d.connect(":1338/chat/"+b.clientname+"/"+c),a.socket.on("message",function(b){var c=b.split("#");a.currentConversation.push({message:c[1],datetime:new Date,sender:c[0]})})},function(){b.addAlert("danger","An error occured.")})},a.getAll=function(){b.toggleLoading(),f.all(null,function(c){a.conversations=c,b.toggleLoading()},function(a){b.toggleLoading(),b.addAlert("danger",a.message)})},a.get=function(c){f.all({id:c},function(b){a.currentConversation=b,angular.forEach(a.currentConversation,function(b,c){var d=new Date(b.datetime);a.currentConversation[c].datetime=d.toDateString()+" "+d.toLocaleTimeString()})},function(a){b.addAlert("danger",a.message)})},a.send=function(){a.socket.emit("message","Team#"+a.yourMessage),a.yourMessage=""},a.numPages=function(){return Math.ceil(a.conversations.length/a.numPerPage)},a.pageChanged=function(){var b=(a.currentPage-1)*a.numPerPage,c=b+a.numPerPage;a.filteredConversations=a.conversations.slice(b,c)},a.$watch("conversations",function(){a.conversations.length>0&&a.pageChanged()}),a.$watch("selectAll.isSelected",function(){a.all()}),a.all=function(){angular.forEach(a.conversations,function(b,c){a.conversations[c].isSelected=a.selectAll.isSelected})}}]),app.controller("ErrorsController",["$scope","$rootScope",function(a,b){a.loading=!1,a.alerts=[],b.toggleLoading=function(){a.loading=!a.loading},b.addAlert=function(b,c){a.alerts.push({type:b,msg:c})},a.closeAlert=function(b){a.alerts.splice(b,1)}}]),app.controller("RootController",["$scope","$rootScope","$window","ResourceService",function(a,b,c,d){b.client={};var e=d.Client;a.init=function(){void 0!==c.sessionStorage.token&&e.me(null,function(a){b.client=a})}}]),app.controller("TableController",["$scope",function(a){a.orderByField="firstName",a.reverseSort=!1}]),app.controller("UsersController",["$scope","$rootScope","$stateParams","ResourceService","uiGmapGoogleMapApi",function(a,b,c,d,e){var f=d.User;a.users=[],a.currentUser={},c.username&&(a.username=c.username),a.numPerPage=20,a.filteredUsers=[],a.currentPage=1,a.selectAll={isSelected:!1},a.getAll=function(){b.toggleLoading(),f.all(null,function(c){a.users=c,angular.forEach(a.users,function(b,c){a.users[c].isSelected=!1}),b.toggleLoading()},function(a){b.toggleLoading(),b.addAlert("danger",a.message)})},a.get=function(c){f.get({id:c},function(b){a.currentUser=b,a.currentUser.geo=a.currentUser.geo.split(","),a.map={center:{latitude:a.currentUser.geo[0],longitude:a.currentUser.geo[1]},zoom:10}},function(a){b.addAlert("danger",a.message)})},a.numPages=function(){return Math.ceil(a.users.length/a.numPerPage)},a.pageChanged=function(){var b=(a.currentPage-1)*a.numPerPage,c=b+a.numPerPage;a.filteredUsers=a.users.slice(b,c)},a.$watch("users",function(){a.users.length>0&&a.pageChanged()}),a.$watch("selectAll.isSelected",function(){a.all()}),a.all=function(){angular.forEach(a.users,function(b,c){a.users[c].isSelected=a.selectAll.isSelected})},e.then(function(){a.map={center:{latitude:0,longitude:0},zoom:8}})}]),app.directive("icheck",["$timeout",function(a){return{require:"ngModel",link:function(b,c,d,e){return a(function(){var a;return a=d.value,b.$watch(d.ngModel,function(){$(c).iCheck("update")}),$(c).iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}).on("ifChanged",function(f){return"checkbox"===$(c).attr("type")&&d.ngModel&&b.$apply(function(){return e.$setViewValue(f.target.checked)}),"radio"===$(c).attr("type")&&d.ngModel?b.$apply(function(){return e.$setViewValue(a)}):void 0})})}}}]),app.factory("AuthInterceptor",["$rootScope","$q","$window","$location",function(a,b,c){return{request:function(a){return a.headers=a.headers||{},c.sessionStorage.token&&(a.headers.Authorization="Bearer "+c.sessionStorage.token),a},responseError:function(a){return b.reject(a)}}}]),app.factory("AuthService",["$http","$window",function(a,b){return{login:function(b){return a.post("/api/sessions",b)},logout:function(){b.sessionStorage.token=!1},isLoggedIn:function(){return"undefined"!==b.sessionStorage.token?!0:!1},getPermissions:function(){}}}]),app.factory("HashFactory",function(){return{make:function(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return CryptoJS.SHA512(b).toString(CryptoJS.enc.Hex)},hash:function(a){return CryptoJS.SHA512(a).toString(CryptoJS.enc.Hex)}}}),app.factory("Socket",function(a){return{connect:function(b){return a({ioSocket:io.connect(b)})}}}),app.factory("ResourceService",["$resource",function(a){var b={update:{method:"PUT"},all:{method:"GET",isArray:!0}},c={id:"@id"},d=b;return d.me={method:"GET",url:"/api/clients/me"},d.isAnonymous={method:"GET",url:"/isAnonymous"},d.isClient={method:"GET",url:"/api/isClient"},d.isAdmin={method:"GET",url:"/api/isAdmin"},d.register={method:"POST",url:"/register"},d.login={method:"POST",url:"/login"},{User:a("/api/users/:id",c,b),Conversation:a("/api/conversations/:id",c,b),Client:a("/api/clients/:id",c,d)}}]),app.config(function(a,b){b.otherwise("/404"),a.state("404",{url:"/404",templateUrl:"/ng/errors/404.html"}).state("login",{url:"/login",templateUrl:"/ng/auth/login.html",data:{permissions:{only:["anonymous"],redirectTo:"home"}}}).state("register",{url:"/register",templateUrl:"/ng/auth/register.html",data:{permissions:{only:["anonymous"],redirectTo:"home"}}}).state("dashboard",{url:"/",templateUrl:"/ng/dashboard/home.html",data:{permissions:{only:["client"],redirectTo:"login"}}}).state("home",{url:"",templateUrl:"/ng/dashboard/home.html",data:{permissions:{only:["client"],redirectTo:"login"}}}).state("users",{url:"/users",templateUrl:"/ng/users/all.html",data:{permissions:{only:["client"],redirectTo:"login"}}}).state("getUser",{url:"/users/:username",templateUrl:"/ng/users/get.html",data:{permissions:{only:["client"],redirectTo:"login"}}}).state("conversations",{url:"/conversations",templateUrl:"/ng/conversations/all.html",data:{permissions:{only:["client"],redirectTo:"login"}}}).state("getConversation",{url:"/conversations/:session/:username",templateUrl:"/ng/conversations/get.html",data:{permissions:{only:["client"],redirectTo:"login"}}})}),app.run(function(a,b,c,d){Client=b.Client,a.defineRole("anonymous",function(){var a=d.defer();return Client.isAnonymous(null,function(b){void 0!=b.clientname&&(c.addAlert("danger","You can't access this page if you're already logged."),a.reject()),a.resolve()},function(){a.reject()}),a.promise}).defineRole("admin",function(){var a=d.defer();return Client.isAdmin(null,function(b){1!=b.admin&&(c.addAlert("danger","You're not authorized to access this page."),a.reject()),a.resolve()},function(){a.reject()}),a.promise}).defineRole("client",function(){var a=d.defer();return Client.isClient(null,function(b){void 0!=b.clientname&&(c.addAlert("danger","You must be logged in to access this page."),a.reject()),a.resolve()},function(){a.reject()}),a.promise})});